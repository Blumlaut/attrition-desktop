name: Create Release
on:
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Get current version
      id: get_version
      run: |
        CURRENT_VERSION=$(node -p "require('./package.json').version")
        echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        echo "Current version is: $CURRENT_VERSION"

    - name: Increment version by 0.0.1
      id: increment_version
      run: |
        CURRENT_VERSION=${{ steps.get_version.outputs.current_version }}
        # Split version into parts
        IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
        MAJOR="${VERSION_PARTS[0]}"
        MINOR="${VERSION_PARTS[1]}"
        PATCH="${VERSION_PARTS[2]}"
        
        # Increment patch version
        NEW_PATCH=$((PATCH + 1))
        NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
        
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "Incremented version from $CURRENT_VERSION to $NEW_VERSION"

    - name: Update package.json with new version
      run: |
        npm version ${{ steps.increment_version.outputs.new_version }} --no-git-tag-version
        echo "Updated package.json to version ${{ steps.increment_version.outputs.new_version }}"

    - name: Build application
      run: |
        npm run build

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ steps.increment_version.outputs.new_version }}
        release_name: Release v${{ steps.increment_version.outputs.new_version }}
        body: |
          Release notes for v${{ steps.increment_version.outputs.new_version }}
          
          - Built application files attached
        draft: false
        prerelease: false

    - name: Upload Windows Build
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./dist/*.exe
        asset_name: attrition-desktop-windows.exe
        asset_content_type: application/octet-stream
      if: hashFiles('./dist/*.exe') != ''

    - name: Upload Linux Build
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./dist/*AppImage*
        asset_name: attrition-desktop-linux.appimage
        asset_content_type: application/octet-stream
      if: hashFiles('./dist/*AppImage*') != ''

    - name: Upload macOS Build
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./dist/*.dmg
        asset_name: attrition-desktop-macos.dmg
        asset_content_type: application/octet-stream
      if: hashFiles('./dist/*.dmg') != ''

    - name: List built files
      run: |
        ls -la ./dist/
